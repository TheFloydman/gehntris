var Gehntris;(()=>{"use strict";var e={8:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PieceInPlay=t.PieceTemplate=t.Board=void 0,t.svgMain=i,t.svgUpcoming=o,t.svgStorage=r,t.Board=class{constructor(e,t,s){this.state=[],this.squareSize=e,this.width=t,this.height=s,this.clear()}clear(){for(let e=0;e<this.height;e++){this.state[e]=[];for(let t=0;t<this.width;t++)this.state[e][t]=void 0}}};class s{constructor(e,t,s){this.shape=e,this.fill=t,this.weight=s}}t.PieceTemplate=s;class n{constructor(e,t,s,n){this.x=e,this.y=t,this.fill=s,this.isShadow=n}draw(e,t,s,n,i=!1){function o(e,t,s,n,i="100%"){const o=document.createElementNS("http://www.w3.org/2000/svg","rect");return o.setAttribute("width",e.toString()),o.setAttribute("height",e.toString()),o.setAttribute("x",t.toString()),o.setAttribute("y",s.toString()),o.setAttribute("fill",n),o.setAttribute("fill-opacity",i),o}this.svgElement=document.createElementNS("http://www.w3.org/2000/svg","svg");const r=o(s.squareSize,e+this.x*s.squareSize,t+this.y*s.squareSize,"#666666"),a=o(s.squareSize-1,e+this.x*s.squareSize+1,t+this.y*s.squareSize+1,"#CCCCCC"),h=o(1,e+this.x*s.squareSize,t+this.y*s.squareSize+7,"#999999"),c=o(1,e+this.x*s.squareSize+7,t+this.y*s.squareSize,"#999999"),u=o(s.squareSize-2,e+this.x*s.squareSize+1,t+this.y*s.squareSize+1,"#FFFFFF"),l=o(s.squareSize,e+this.x*s.squareSize,t+this.y*s.squareSize,this.fill,"50%");this.isShadow||this.svgElement.append(r,a,h,c,u),this.svgElement.append(l),n.append(this.svgElement)}canMove(e,t,s){const n=this.x+e,i=this.y+t,o=s.state[i]&&s.state[i][n],r=n<0,a=n>=s.width,h=i<0,c=i>=s.height;return!(o||r||a||h||c)}move(e,t,s){this.canMove(e,t,s)&&this.setPos(this.x+e,this.y+t)}setPos(e,t){this.x=e,this.y=t}}function i(){return document.getElementById("svg-main")}function o(){return document.getElementById("svg-upcoming")}function r(){return document.getElementById("svg-storage")}t.PieceInPlay=class{constructor(e,t=!1){this.squares=[],this.shadowSquares=[],this.stored=!1,this.ticksAlive=0,this.template=e,this.fill=e.fill,this.waiting=t;for(let t=0;t<e.shape.length;t++)for(let s=0;s<e.shape[t].length;s++)e.shape[t][s]&&this.squares.push(new n(s,t,this.fill,!1))}draw(e,t,s){this.waiting||this.stored||this.drawShadow(s);for(let n=0;n<this.squares.length;n++){let a=i();this.waiting&&(a=o()),this.stored&&(a=r()),this.squares[n].draw(e,t,s,a,this.waiting)}}drawShadow(e){for(let e=0;e<this.shadowSquares.length;e++)this.shadowSquares[e].svgElement.remove();this.shadowSquares=[];let t=1;for(;this.canMove(0,t,e);)t++;t--;for(let e=0;e<this.squares.length;e++)this.shadowSquares.push(new n(this.squares[e].x,this.squares[e].y+t,"#A0A0A0",!0));for(let t=0;t<this.shadowSquares.length;t++)this.shadowSquares[t].draw(0,0,e,i())}canMove(e,t,s){for(let n=0;n<this.squares.length;n++)if(!this.squares[n].canMove(e,t,s))return!1;return!0}move(e,t,s){if(this.canMove(e,t,s))for(let n=0;n<this.squares.length;n++)this.squares[n].move(e,t,s)}setPos(e,t){const s=Math.min(...this.squares.map((e=>e.x))),n=Math.min(...this.squares.map((e=>e.y)));for(let i=0;i<this.squares.length;i++){const o=this.squares[i];o.setPos(o.x-s+e,o.y-n+t)}}drop(e){let t=1;for(;this.canMove(0,t,e);)t++;t--,this.move(0,t,e)}convert(e){for(let t=0;t<this.squares.length;t++){const s=this.squares[t];if(e.state[s.y][s.x])return!1;e.state[s.y][s.x]=s}return!0}rotate(e){const t=Math.min(...this.squares.map((e=>e.x))),i=Math.min(...this.squares.map((e=>e.y))),o=this.rotate2DArray(this.template.shape),r=[];for(let e=0;e<o.length;e++)for(let s=0;s<o[e].length;s++)o[e][s]&&r.push(new n(t+s,i+e,this.fill,!1));let a=Math.min(...r.map((e=>e.x))),h=Math.max(...r.map((e=>e.x))),c=Math.min(...r.map((e=>e.y))),u=Math.max(...r.map((e=>e.y))),l=0,d=0;a<0?l=-a:h>=e.width&&(l=e.width-1-h),c<0?d=-c:u>=e.height&&(d=e.height-1-u);for(let e of r)e.x+=l,e.y+=d;r.every((t=>{const s=t.x,n=t.y;return s>=0&&s<e.width&&n>=0&&n<e.height&&(!e.state[n]||!e.state[n][s])}))&&(this.template=new s(o,this.fill,1),this.squares=r)}rotate2DArray(e){const t=[];return e.forEach((function(e,s,n){e.forEach((function(e,i,o){t[i]=t[i]||[],t[i][n.length-s-1]=e}))})),t}}}},t={};function s(n){var i=t[n];if(void 0!==i)return i.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,s),o.exports}var n={};(()=>{var e=n;Object.defineProperty(e,"__esModule",{value:!0}),e.onBodyLoad=async function(){await async function(){const e=await fetch("./templates.json"),s=await e.json();for(let e=0;e<s.templates.length;e++){const n=s.templates[e],r=new t.PieceTemplate(n.shape,i[o[e]],n.weight);a.push(r)}}(),(0,t.svgMain)().setAttribute("viewBox",`0 0 ${c.x*h} ${c.y*h}`),(0,t.svgUpcoming)().setAttribute("viewBox",`0 0 ${u.x*h} ${u.y*h}`),(0,t.svgStorage)().setAttribute("viewBox",`0 0 ${l.x*h} ${l.y*h}`),Y(),function(){const e=document.getElementById("pause-button");["mousedown","touchstart","pointerdown"].forEach((s=>{(0,t.svgStorage)().addEventListener(s,(e=>{X=!0})),e.addEventListener(s,(e=>{D=!0}))})),["mouseup","touchend","pointerup"].forEach((s=>{(0,t.svgStorage)().addEventListener(s,(e=>{X&&!C&&($(),te(),te(),te()),X=!1})),e.addEventListener(s,(e=>{D=!1}))})),["mouseleave","touchcancel","pointercancel"].forEach((s=>{(0,t.svgStorage)().addEventListener(s,(e=>{X=!1})),e.addEventListener(s,(e=>{D=!1}))})),document.addEventListener("keydown",(e=>{!q&&v&&("Escape"==e.code&&_(),M||("ArrowLeft"==e.code||"KeyA"==e.code?Q():"ArrowRight"==e.code||"KeyD"==e.code?V():"ArrowDown"==e.code||"KeyS"==e.code?Z():"ArrowUp"==e.code||"KeyW"==e.code?te():"Space"==e.code?ee():"Tab"!=e.code||C||$()),e.preventDefault())})),["mousemove","touchmove","pointermove","drag"].forEach((e=>{document.addEventListener(e,(function(e){if(e instanceof TouchEvent)B=e.changedTouches[0].clientX,P=e.changedTouches[0].clientY;else{if(D)return;B=e.clientX,P=e.clientY}}))})),["mousedown","touchstart","pointerdown"].forEach((e=>{document.addEventListener(e,(function(e){if(null==p){if(F=!1,e instanceof TouchEvent)A=e.touches[0].clientX,L=e.touches[0].clientY;else{if(D)return;A=e.clientX,L=e.clientY}b=0,clearInterval(p),p=setInterval(W,T)}F=!1}))})),["mouseup","mouseleave","touchend","touchcancel","pointerup","pointercancel"].forEach((e=>{document.addEventListener(e,(function(e){if(e instanceof TouchEvent)B=e.changedTouches[0].clientX,P=e.changedTouches[0].clientY;else{if(D)return;B=e.clientX,P=e.clientY}clearInterval(p),p=void 0,F=!0,J()}))}))}()},e.togglePause=_;const t=s(8),i=["#FF0000","#00FF00","#FFAF2E","#0000FF","#8D28B8","#FFFF00"],o=[];for(;o.length<i.length;){var r=Math.floor(Math.random()*i.length);-1===o.indexOf(r)&&r<i.length&&o.push(r)}const a=[],h=8,c={x:10,y:25},u={x:5,y:4},l={x:5,y:5},d=new t.Board(h,c.x,c.y);let f,v,g,m,p,w=1e3,y=!0,q=!1,M=!0,E=0,S=0,x=0,I=!1,A=0,L=0,B=0,P=0,T=50,b=0,F=!1,z=!1,H=0,C=!1,D=!1,X=!1;function Y(){const e=a.map((e=>e.weight)).reduce(((e,t)=>e+t),0);let s,n=0;const i=a.reduce(((t,s)=>(t.set([n,n+s.weight/e],s),n+=s.weight/e,t)),new Map).entries();for(;!s;){const e=Math.random();for(const[t,n]of i)e>=t[0]&&e<=t[1]&&(s=n)}const o=new t.PieceInPlay(s,!0);g=o}function $(){let e=v;k(null!=m),C=!0,m=e,m.stored=!0,m.setPos(0,0),clearInterval(f),f=void 0,R(),H++}function k(e=!1){e?(v=m,v.setPos(3,0),v.stored=!1):(v=g,v.setPos(3,0),v.waiting=!1,Y(),y=!1)}function j(e){E+=e,K(E)}function K(e){document.getElementById("score-value").innerHTML=e.toString()}function N(e){document.getElementById("level-value").innerHTML=e.toString(),w=Math.max(50,1e3-50*(e+1)),clearInterval(f),O()}function U(){for(let e=0;e<d.state.length;e++){let t=!0;for(let s=0;s<d.state[e].length;s++)if(!d.state[e][s]){t=!1;break}if(t)return e}return-1}function _(){if(q)return(0,t.svgMain)().innerHTML="",x=0,E=0,S=0,K(0),N(0),q=!1,M=!1,w=1e3,O(),void(document.getElementById("pause-button").innerHTML="Pause");M=!M,M?function(){document.getElementById("pause-button").innerHTML="Resume",clearInterval(f),f=void 0;const e=document.getElementById("pause").cloneNode(!0);e.id="pause-copy",(0,t.svgMain)().append(e)}():(document.getElementById("pause-button").innerHTML="Pause",document.getElementById("pause-copy")?.remove(),O())}function O(){clearInterval(f),f=setInterval(R,w),R()}function R(){if(H<=0){if(q)return void function(){clearInterval(f),f=void 0;const e=document.getElementById("game-over").cloneNode(!0);(0,t.svgMain)().append(e),document.getElementById("pause-button").innerHTML="Restart",q=!0,d.clear()}();(0,t.svgMain)().innerHTML="",(0,t.svgUpcoming)().innerHTML="",(0,t.svgStorage)().innerHTML="";for(let e=0;e<d.state.length;e++)for(let s=0;s<d.state[e].length;s++)null!=d.state[e][s]&&d.state[e][s].draw(0,0,d,(0,t.svgMain)());if(!M){if(v)if(v.ticksAlive++,v.canMove(0,1,d))v.ticksAlive*w>1e3&&!z&&v.move(0,1,d);else if(G(),!q)return;y&&k()}g.draw(0,0,d),v&&v.draw(0,0,d),m&&m.draw(0,0,d),z=!1,x++}else H--}function G(){q=!function(e){const t=e.convert(d);return t&&(v=void 0,y=!0),e.draw(0,0,d),j(5),t}(v),function(){let e=0,t=U();for(;t>=0;){e+=1;for(let e=t;e>0;e--)for(let t=0;t<d.state[e].length;t++)d.state[e-1][t]?(d.state[e][t]=d.state[e-1][t],d.state[e][t].y+=1):d.state[e][t]=void 0;for(let e=0;e<d.state[0].length;e++)d.state[0][e]=void 0;t=U()}j(5==e?125*e:25*e),S+=e,N(Math.floor(S/5)+1),C=!1}(),clearInterval(p),p=void 0,F=!0}function W(){I=!1,b+=T,b%200==0&&J()}function J(){if(!q&&!M&&v&&!I){const e=B-A,t=P-L;Math.abs(e)>Math.abs(t)?e>50&&!F?V():e<-50&&!F?Q():b<250&&te():t>50&&!F?Z():t<-50&&b<250?ee():b<250&&te(),I=!0,F=!1}}function Q(){v.canMove(-1,0,d)&&(v.move(-1,0,d),se())}function V(){v.canMove(1,0,d)&&(v.move(1,0,d),se())}function Z(){v.canMove(0,1,d)&&(v.move(0,1,d),se(),z=!0)}function ee(){if(v.canMove(0,1,d)){for(let e=0;e<v.squares.length;e++)v.squares[e].svgElement.remove();v.drop(d),H++,G()}}function te(){for(let e=0;e<v.squares.length;e++)v.squares[e].svgElement.remove();v.rotate(d),v.draw(0,0,d)}function se(){for(let e=0;e<v.squares.length;e++)v.squares[e].svgElement.remove();v.draw(0,0,d)}})(),Gehntris=n})();
//# sourceMappingURL=gehntris.js.map